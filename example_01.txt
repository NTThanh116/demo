Sub Split_By_SetID_Strict()

    Dim wsData As Worksheet
    Dim wsOut As Worksheet
    Dim lastRow As Long
    Dim lastCol As Long
    Dim i As Long
    Dim r As Long
    Dim setID As Long
    
    Dim currentSub As Long
    Dim currentStep As Variant
    
    Application.ScreenUpdating = False
    
    ' ===== Sheet nguồn =====
    Set wsData = ThisWorkbook.Sheets("ALL_RESULTS")
    
    lastRow = wsData.Cells(wsData.Rows.Count, "A").End(xlUp).Row
    lastCol = wsData.Cells(1, wsData.Columns.Count).End(xlToLeft).Column
    
    ' ===== Loop theo SetID =====
    For setID = 1 To 3
        
        ' Xóa sheet cũ nếu tồn tại
        On Error Resume Next
        Application.DisplayAlerts = False
        ThisWorkbook.Sheets("SUMMARY_SET_" & setID).Delete
        Application.DisplayAlerts = True
        On Error GoTo 0
        
        ' Tạo sheet mới
        Set wsOut = ThisWorkbook.Sheets.Add
        wsOut.Name = "SUMMARY_SET_" & setID
        
        ' Copy header
        wsOut.Range(wsOut.Cells(1, 1), wsOut.Cells(1, lastCol)).Value = _
            wsData.Range(wsData.Cells(1, 1), wsData.Cells(1, lastCol)).Value
        
        r = 2
        
        ' ===== Loop từng dòng data =====
        For i = 2 To lastRow
            
            currentSub = wsData.Cells(i, 2).Value     ' Subcase (cột B)
            currentStep = wsData.Cells(i, 3).Value    ' Step (cột C)
            
            ' ===== Filter đúng SetID (cột D) =====
            If wsData.Cells(i, 4).Value = setID Then
                
                ' ===== Bỏ Step 0 của Subcase > 1 =====
                If currentSub > 1 And currentStep = 0 Then
                    ' Skip dòng này
                Else
                    wsOut.Range(wsOut.Cells(r, 1), wsOut.Cells(r, lastCol)).Value = _
                        wsData.Range(wsData.Cells(i, 1), wsData.Cells(i, lastCol)).Value
                    r = r + 1
                End If
                
            End If
            
        Next i
        
        wsOut.Columns.AutoFit
        
    Next setID
    
    Application.ScreenUpdating = True
    
    MsgBox "Split by SetID completed. Step 0 of Subcase 2 & 3 removed.", vbInformation

End Sub
