Sub Split_By_Idset_Correct()

    Dim wsData As Worksheet
    Dim wsOut As Worksheet
    Dim lastRow As Long
    Dim dict As Object
    Dim idVal As Variant
    Dim i As Long
    Dim r As Long
    
    Set wsData = ThisWorkbook.Worksheets(1)  ' sheet ALL_RESULTS
    
    lastRow = wsData.Cells(wsData.Rows.Count, "A").End(xlUp).Row
    
    Set dict = CreateObject("Scripting.Dictionary")
    
    ' ===== Lấy Idset từ cột D =====
    For i = 2 To lastRow
        idVal = wsData.Cells(i, 4).Value   ' <-- CỘT D (SetID)
        
        If Not dict.exists(idVal) Then
            dict.Add idVal, 1
        End If
    Next i
    
    ' ===== Tạo sheet cho từng Idset =====
    For Each idVal In dict.Keys
        
        On Error Resume Next
        Application.DisplayAlerts = False
        Sheets("SUMMARY_IDSET_" & idVal).Delete
        Application.DisplayAlerts = True
        On Error GoTo 0
        
        Set wsOut = Sheets.Add
        wsOut.Name = "SUMMARY_IDSET_" & idVal
        
        ' Copy header
        wsOut.Range("A1:W1").Value = wsData.Range("A1:W1").Value
        
        r = 2
        
        For i = 2 To lastRow
            
            If wsData.Cells(i, 4).Value = idVal Then   ' <-- FILTER CỘT D
                
                wsOut.Range("A" & r & ":W" & r).Value = _
                    wsData.Range("A" & i & ":W" & i).Value
                
                r = r + 1
                
            End If
            
        Next i
        
        wsOut.Columns.AutoFit
        
    Next idVal
    
    MsgBox "Split by Idset completed!", vbInformation

End Sub
