Sub Split_By_Idset()

    Dim wsData As Worksheet
    Dim wsOut As Worksheet
    Dim lastRow As Long
    Dim dict As Object
    Dim idVal As Variant
    Dim i As Long
    Dim r As Long
    
    Set wsData = ThisWorkbook.Sheets("ALL_RESULTS.xlsm") ' sửa nếu cần
    
    lastRow = wsData.Cells(wsData.Rows.Count, "A").End(xlUp).Row
    
    Set dict = CreateObject("Scripting.Dictionary")
    
    ' ===== Lấy danh sách Idset duy nhất =====
    For i = 2 To lastRow
        idVal = wsData.Cells(i, 2).Value   ' cột Idset
        If Not dict.exists(idVal) Then
            dict.Add idVal, 1
        End If
    Next i
    
    ' ===== Tạo sheet cho từng Idset =====
    For Each idVal In dict.Keys
        
        ' Xóa sheet cũ nếu tồn tại
        On Error Resume Next
        Application.DisplayAlerts = False
        Sheets("SUMMARY_IDSET_" & idVal).Delete
        Application.DisplayAlerts = True
        On Error GoTo 0
        
        Set wsOut = Sheets.Add
        wsOut.Name = "SUMMARY_IDSET_" & idVal
        
        ' Header
        wsOut.Range("A1:W1").Value = wsData.Range("A1:W1").Value
        
        r = 2
        
        ' Copy data tương ứng Idset
        For i = 2 To lastRow
            
            If wsData.Cells(i, 2).Value = idVal Then
                
                wsOut.Range("A" & r & ":W" & r).Value = _
                    wsData.Range("A" & i & ":W" & i).Value
                
                r = r + 1
                
            End If
            
        Next i
        
        wsOut.Columns.AutoFit
        
    Next idVal
    
    MsgBox "Split by Idset completed!", vbInformation

End Sub
