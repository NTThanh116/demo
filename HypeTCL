# ================= PATH =================
set script_path [file dirname [file normalize [info script]]]
set out_root   "$script_path/CSV_Result"
set log_file   "$script_path/export_log.txt"

file mkdir $out_root
set flog [open $log_file w]

proc logmsg {fp msg} {
    puts $fp "[clock format [clock seconds] -format {%Y-%m-%d %H:%M:%S}]  $msg"
    flush $fp
}

logmsg $flog "=== SCRIPT START ==="

# ================= GET HANDLES (FIXED) =================
hw GetSessionHandle session
$session GetProjectHandle project

$project GetPageHandle page [$project GetActivePage]
$page GetActiveWindow win [$page GetActiveWindow]
$win GetClientHandle client [$win GetActiveModel]
$client GetModelHandle model [$client GetActiveModel]

$model GetResultCtrlHandle result
$result GetContourCtrlHandle contour
$model GetQueryCtrlHandle query

# ================= CONTOUR =================
$contour SetCornerDataEnabled true
$contour SetAverageMode simple

$contour GetLegendHandle legend
$legend SetNumericFormat Scientific
$legend SetNumericPrecision 6

$query SetRemoveDuplicates false

# ================= USER SETTING =================
set subcases   {1 2 3}
set setIDs     {7}
set components {XX XY YY XZ YZ ZZ}

array set datatypes {
    S   "S-Global-Stress components"
    E   "E-Global-Strain components"
    THE "THE-Global-Thermal Strain components"
}

# ================= MAIN LOOP =================
foreach sc $subcases {

    logmsg $flog "Processing Subcase $sc"
    $result SetCurrentSubcase $sc

    set simList [$result GetSimulationList]
    set nsim    [llength $simList]

    set sub_dir "$out_root/Subcase_$sc"
    file mkdir $sub_dir

    foreach setID $setIDs {

        set outfile "$sub_dir/Set_${setID}.csv"
        logmsg $flog "  Exporting Set $setID â†’ $outfile"

        set fp [open $outfile w]

        puts $fp "Step,\
S_XX,S_XY,S_YY,S_XZ,S_YZ,S_ZZ,\
E_XX,E_XY,E_YY,E_XZ,E_YZ,E_ZZ,\
THE_XX,THE_XY,THE_YY,THE_XZ,THE_YZ,THE_ZZ"

        for {set k 0} {$k < $nsim} {incr k} {

            $result SetCurrentSimulation $k
            set row "$k"

            foreach dtype {S E THE} {
                $contour SetDataType $datatypes($dtype)

                foreach comp $components {
                    $contour SetDataComponent $comp
                    $query SetSelectionSet "SETS_ID_POOL $setID"
                    $query SetQuery "contour.value"

                    set val [lindex [$query GetValue] 0]
                    append row ",$val"
                }
            }

            puts $fp $row
        }

        close $fp
        logmsg $flog "  Finished Set $setID"
    }
}

logmsg $flog "=== SCRIPT END ==="
close $flog
