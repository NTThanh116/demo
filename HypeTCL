# ============================================================
# OPTIMIZED EXPORT - OLD API SAFE VERSION (USE ORIGINAL CORE)
# Keep original HyperView commands: WriteData only (NO GetValue)
# Only fix: correct component names + correct output order per datatype
# ============================================================

set t [::post::GetT]
set script_path [file dirname [file normalize [info script]]]
set type "node"

# helper: read last numeric value from tmp csv (contour.value)
proc readContourValueFromTmp {tmpfile} {
    if {![file exists $tmpfile]} { return "" }
    set fp [open $tmpfile r]
    set lines [split [read $fp] "\n"]
    close $fp

    # find last non-empty data line (skip header)
    set last ""
    foreach line $lines {
        set s [string trim $line]
        if {$s eq ""} { continue }
        # skip header line that contains "node.id" etc.
        if {[string match "*node*" $s] && [string match "*contour*" $s]} { continue }
        set last $s
    }
    if {$last eq ""} { return "" }

    # CSV columns: node.id, component.name, contour.value  -> take last column
    set cols [split $last ","]
    set val [string trim [lindex $cols end]]
    return $val
}

for {set i 1} {$i < 2} {incr i} {

    # ===== ORIGINAL HANDLES (UNCHANGED) =====
    hwi GetSessionHandle session_$i$t
    session_$i$t GetProjectHandle project_$i$t
    project_$i$t GetPageHandle page_$i$t [project_$i$t GetActivePage $i]
    page_$i$t SetActiveWindow $i
    page_$i$t GetWindowHandle win_$i$t [page_$i$t GetActiveWindow]
    win_$i$t GetClientHandle client_$i$t
    client_$i$t GetModelHandle my_model_$i$t [client_$i$t GetActiveModel]

    my_model_$i$t GetResultCtrlHandle result_$i$t
    result_$i$t GetContourCtrlHandle contour_handle_$i$t

    contour_handle_$i$t SetCornerDataEnabled True
    contour_handle_$i$t SetAverageMode simple
    contour_handle_$i$t GetLegendHandle leg_handle_$i$t
    leg_handle_$i$t SetNumericFormat Scientific
    leg_handle_$i$t SetNumericPrecision 6

    my_model_$i$t GetQueryCtrlHandle myQueryName_$i$t
    myQueryName_$i$t SetRemoveDuplicates false

    set list_set_id [my_model_$i$t GetSelectionSetList]
    set set_id_comp [split $list_set_id " "]

    # ===== USER SETTING =====
    set subcases {1 2 3}

    # ===== FIX: component order EXACTLY like HyperView dropdowns =====
    # Stress: S11 S22 S33 S12 S13 S23
    set components_S {S11 S22 S33 S12 S13 S23}

    # Total strain: XX YY ZZ XY YZ ZX
    set components_E {XX YY ZZ XY YZ ZX}

    # Thermal strain: THE11 THE22 THE33 THE12 THE13 THE23
    set components_THE {THE11 THE22 THE33 THE12 THE13 THE23}

    # ===== datatype mapping KEEP YOUR ORIGINAL STRINGS (because this is the working part) =====
    array set datatypes {
        1 "E-Global-Strain components"
        2 "S-Global-Stress components"
        3 "THE-Global-Thermal Strain components"
    }

    foreach j $subcases {

        result_$i$t SetCurrentSubcase $j
        set timelist [result_$i$t GetSimulationList $j]
        set nsim [llength $timelist]

        foreach comp_set $set_id_comp {

            set set_ID [regexp -all -inline -- {[0-9]+} $comp_set]
            if {$set_ID != 7} { continue }

            # ---- Summary output ----
            set outSummary "$script_path/Subcase_${j}_Set_${set_ID}.csv"
            set fps [open $outSummary w]

            # ===== FIX: HEADER đúng thứ tự như HyperView =====
            puts $fps "Step,\
S11,S22,S33,S12,S13,S23,\
E_XX,E_YY,E_ZZ,E_XY,E_YZ,E_ZX,\
THE11,THE22,THE33,THE12,THE13,THE23"

            # tmp file (reuse)
            set tmpfile "$script_path/__tmp_export_${j}_${set_ID}.csv"

            for {set k 0} {$k < $nsim} {incr k} {

                result_$i$t SetCurrentSimulation $k
                set row "$k"

                # ===== GIỮ CORE CŨ: loop theo dtypeOrder S, E, THE =====
                foreach dtypeOrder {2 1 3} {

                    contour_handle_$i$t SetDataType $datatypes($dtypeOrder)

                    # ===== CHỈ ĐỔI LIST COMPONENT THEO DATATYPE =====
                    if {$dtypeOrder == 2} {
                        set components $components_S
                    } elseif {$dtypeOrder == 1} {
                        set components $components_E
                    } else {
                        set components $components_THE
                    }

                    foreach comp $components {

                        contour_handle_$i$t SetDataComponent $comp
                        myQueryName_$i$t SetSelectionSet "SETS_ID_POOL $set_ID"
                        myQueryName_$i$t SetQuery "node.id, component.name, contour.value"

                        myQueryName_$i$t WriteData $tmpfile

                        set val [readContourValueFromTmp $tmpfile]
                        append row ",$val"
                    }
                }

                puts $fps $row
            }

            close $fps
            catch {file delete -force $tmpfile}
        }
    }
}
